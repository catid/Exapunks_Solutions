; Score: 643 cycles

;--------------------------------------------------------------------
; XA
;--------------------------------------------------------------------

GRAB 300
LINK 800

REPL DUDE_COMBINER

LINK 801

COPY F X ; COPY SOURCE
REPL DUDE

MODE ; LOCAL
COPY M X ; WAIT

MODE ; GLOBAL
COPY F X ; COPY DEST
REPL DUDE

MODE ; LOCAL
COPY M X ; WAIT

WIPE
HALT


; X = DUDE TO WRITE
; GLOBAL MODE
MARK DUDE
GRAB 200

MARK A
TEST F = X
TJMP FOUND
SEEK 10
JUMP A

MARK FOUND
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M

MODE ; LOCAL
COPY 1 M ; FLAG DONE
HALT


; COMBINE TWO DUDES
; GLOBAL MODE
MARK DUDE_COMBINER
MAKE
COPY 20 T
MARK C0
COPY M F
COPY M F
COPY M F
COPY M F
SUBI T 4 T
TJMP C0

SEEK -9999

MARK NEXT

; READ ID
COPY F X
REPL READ

; CHECK IF WE NEED CACHE
SWIZ X 4320 X
SEEK 9
SWIZ F 4320 T
TEST X = T
SEEK -1
COPY F X
TJMP NEED_CACHE

REPL WRITE
JUMP WAIT
MARK NEED_CACHE
REPL CACHED_WRITE

; WAIT FOR RESULT
MARK WAIT
MODE ; LOCAL
COPY M X ; WAIT LOCAL
MODE ; GLOBAL
TEST EOF
SEEK -10
FJMP NEXT
WIPE
HALT

; X = CHUNK TO READ
; GLOBAL MODE
MARK READ
SWIZ X 0003 T
ADDI T 800 T
LINK T

SWIZ X 0002 T
ADDI T 200 T
GRAB T

SWIZ X 0001 T
MULI T 10 T
SEEK T

JUMP FTMWIPE

; X = CHUNK TO WRITE
; GLOBAL MODE
MARK WRITE
SWIZ X 0003 T
ADDI T 800 T
LINK T

SWIZ X 0002 T
ADDI T 200 T
GRAB T

SWIZ X 0001 T
MULI T 10 T
SEEK T

COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
DROP

; FLAG SUCCESS
MODE ; LOCAL
LINK -1
COPY 1 M
HALT

; CACHED WRITE
; GLOBAL MODE
MARK CACHED_WRITE
MAKE
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
COPY M F
REPL WRITE
SEEK -9999

MARK FTMWIPE
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
COPY F M
WIPE
